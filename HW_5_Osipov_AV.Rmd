---
title: "HW_5_Osipov_AV"
output: html_notebook
editor_options: 
  markdown: 
    wrap: 72
---

Домашнее задание 5 Тема: построение регрессионных моделей и анализ
выживаемости.

Цель: научиться пользоваться основными методами регрессионного анализа,
разобраться с принципами анализа выживаемости.

Датасет: Breast Cancer Wisconsin.

В колонке diagnosis содержится информация об опухоли (M =
злокачественная, B = доброкачественная).

### Загрузка библиотек

```{r}
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)
library(ggsurvplot)
```

### Загрузка и преобразование данных

```{r}
BCW <- read.csv("wisconsin_breast_cancer.csv")

head(BCW)
str(BCW)
```

## Задание 1 (2 балла)

Создайте регрессионную модель, которая бы описывала связь среднего
радиуса опухоли(radius_mean) и средней площади(area_mean) (а), среднего
периметра (perimeter_mean) (б), средней симметричности (symmetry_mean)
(в).

```{r}
# Проверка пропущенных значений по изучаемым столбцам
colSums(is.na(BCW[c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean")]))
```

Зададим уровень значимости alpha = 0.05 и гипотезы:

*Н0 - зависимая переменная и фактор не имеют статистически значимой
линейной зависимости*

*Н1 - зависимая переменная и фактор имеют статистически значимую
линейную зависимость*

```{r}
# Создаем модель линейной регрессии
model <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = BCW)

# Выводим сводку модели
summary(model)
```

### Оценка коэффициентов:

Перехват (Intercept): При нулевых значениях всех трех предикторов
(area_mean, perimeter_mean, symmetry_mean) прогнозируемое среднее
значение radius_mean составляет 2,0101598. Площадь (area_mean): На
каждую единицу увеличения area_mean прогнозируемое среднее значение
radius_mean увеличивается на 0,0007378. Периметр (perimeter_mean): На
каждую единицу увеличения perimeter_mean прогнозируемое среднее значение
radius_mean увеличивается на 0,1350754. Симметрия (symmetry_mean): На
каждую единицу уменьшения symmetry_mean (увеличения асимметрии)
прогнозируемое среднее значение radius_mean уменьшается на 4,3541675.
Статистическая значимость:

Все три предиктора статистически значимы (p-value \< 0,001) в объяснении
вариации radius_mean. Адекватность модели:

Модель имеет высокий коэффициент детерминации R-квадрат (0,9971), что
указывает на то, что она объясняет 99,71% вариации radius_mean.
Стандартная ошибка остатков составляет 0,1898, что указывает на то, что
прогнозируемые значения радиуса в среднем находятся в пределах 0,1898
единиц от фактических значений.

### Вывод:

Регрессионные модели показывают, что существует положительная корреляция
между радиусом опухоли и площадью, периметром и симметричностью. Это
означает, что по мере увеличения площади, периметра или симметричности
опухоли также имеет тенденцию увеличиваться ее радиус. Все модели
статистически значимы и имеют высокие коэффициенты детерминации, что
указывает на то, что они хорошо описывают данные.

Постройте графики, на которых отразите регрессионную прямую, и
прокомментируйте свои находки.

```{r}
# Постройте графики регрессионных линий и точек данных
ggplot(BCW, aes(x = area_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Связь между радиусом опухоли и площадью",
       x = "Площадь",
       y = "Радиус")

ggplot(BCW, aes(x = perimeter_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Связь между радиусом опухоли и периметром",
       x = "Периметр",
       y = "Радиус")

ggplot(BCW, aes(x = symmetry_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Связь между радиусом опухоли и симметричностью",
       x = "Симметричность",
       y = "Радиус")
```

### Вывод:

В целом можно сказать, что все факторы имеют линейную зависимость с
зависимой переменной (средний радиус опухоли).

## Задание 2 (2 балла)

Пусть колонка с диагнозом принимает следующие значения: злокачественная
опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы
прогнозировала вероятность возникновения злокачественной опухоли (diagnosis) от
среднего радиуса (radius_mean) (а), средней площади (area_mean) (б), средней текстуры (texture_mean) (в).

```{r}
# Преобразование столбца с диагнозом
BCW$diagnosis <- ifelse(BCW$diagnosis == 'M', 1, 0)

# Проверка
head(select(BCW, diagnosis))
```
Зададим уровень значимости alpha = 0.05 и гипотезы:

*Н0 - зависимая переменная и фактор не имеют статистически значимой зависимости*

*Н1 - зависимая переменная и фактор имеют статистически значимую зависимость*

В данном случае целесообразно построить модель логистической ререссии, так как зависимая переменная - бинарная
```{r}
# Создаем модель логистической регрессии
model2 <-
  glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = BCW, family = "binomial")
summary(model2)
```
### Оценка коэффициентов:

Intercept: -9,48796. Это расчетная вероятность наличия диагноза при средних значениях всех трех предикторов.
radius_mean: -0,38523. Коэффициент для radius_mean сигнализирует, что при увеличении среднего радиуса на одну единицу вероятность диагноза уменьшается на 0,38523. Однако это изменение не является статистически значимым (p = 0,687).
area_mean: 0,01636. Коэффициент для area_mean показывает, что при увеличении средней площади на одну единицу вероятность диагноза увеличивается на 0,01636. Опять же, изменение не статистически значимо (p = 0,137).
texture_mean: 0,20917. Коэффициент для texture_mean указывает, что при увеличении средней текстуры на одну единицу вероятность диагноза увеличивается на 0,20917. Это изменение является статистически значимым (p < 0,001).
Статистическая значимость:

Значения p для radius_mean и area_mean превышают 0,05, что указывает на то, что их коэффициенты не статистически значимы. Однако значение p для texture_mean меньше 0,001, что указывает на то, что его коэффициент статистически значим.

### Выводы:

Модель прогнозирует вероятность диагноза на основе среднего радиуса, средней площади и средней текстуры клеток. Статистически значимым предиктором является только средняя текстура, что указывает на то, что эта характеристика сильнее всего связана с диагнозом.


Постройте графики.

```{r}
# Постройте графики регрессионных линий и точек данных
ggplot(BCW, aes(x = radius_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(title = "Связь между типом опухоли и среней радиусом опухоли",
       x = "Средний радиус опухолиь",
       y = "Тип опухоли")

ggplot(BCW, aes(x = area_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(title = "Связь между типом опухоли и среней площадью опухоли",
       x = "Средняя площадь опухоли",
       y = "Тип опухоли")

ggplot(BCW, aes(x = texture_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  labs(title = "Связь между типом опухоли и сренего значения текстуры опухоли",
       x = "Сренее значения текстуры опухоли",
       y = "Тип опухоли")
```

Создайте модель, которая бы прогнозировала
вероятность возникновения злокачественной опухоли от всех трех
перечисленных факторов.
```{r}
model3 <-
  glm(diagnosis ~ radius_mean * area_mean * texture_mean,
      data = BCW,
      family = "binomial")

summary(model3)
```
По результатам логистической регрессии с взаимодействием всех 3 факторов, мы видим, что все взаимодействия статистически не значимы, так как `p-value > alpha`.


## Задание 3 (6 балла)

Для выполнения этого задания вам понадобится датасет
lung, который встроен в пакет survival. Установите этот пакет и
загрузите датасет.
```{r}
lung <- survival::lung
head(lung)
```

Датасет содержит следующий набор переменных:

inst: код учреждения;
time: время выживаемости в днях;
status: 1 = цензурирование, 2 = смерть;
age: возраст в годах;
sex: мужской = 1,женский = 2;
ph.ecog: шкала опросника ECOG (оценку проводит врач).
0 = отсутствие симптомов,
1= симптомы есть, но пациент наблюдается амбулаторно,
2 = меньше половины дня пациент вынужден проводить в постели,
3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели,
4 = прикован к постели;
ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
meal.cal: калории потребляемой пищи;
wt.loss: потеря веса за последние полгода.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.
```{r}
# Создаем переменную
lung$event <- ifelse(lung$status == 2,1,0)
head(lung)

# делаем выборку только тех пациентов, которые достигли целевого события (смерть)
lung_2 <- filter(lung,lung$event == 1)
head(lung_2)
```
Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
```{r}
# График кривых выживаемости в зависимости от пола
surv_fit <- survfit(Surv(time, status) ~ sex, data = lung_2)

ggsurvplot(surv_fit, conf.int = TRUE, surv.median.line = 'hv', risk.table = TRUE)
```
### Выводы:
На графике мы видим, что доверительные интервалы двух групп пересекаются, линии графика также пересекаются. Это может говорить об отсутсвии значимых различий между полом по выживаемости.

Постройте график кумулятивной функции рисков (cumulative hazard function) для пола.Проинтерпретируйте график.
```{r}
# График кумулятивной функции рисков по полу
ggsurvplot(surv_fit, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```
### Выводы:
На графике мы видим, что доверительные интервалы двух групп пересекаются, линии графика также пересекаются. Это может говорить об отсутсвии значимых различий между полом по уровню риска.


С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы
можете сказать о полученных результатах?
```{r}
# регрессия Кокса
cox <- coxph(Surv(time, status) ~ sex, data = lung_2)
summary(cox)
```
### Выводы:
По результатам мы видим `p-value = 0.136`, то есть разница между двумя группами по полу статистически незначима, так `p-value > alpha.`


Как отправить задание на проверку: Загрузите файлы на GitHub, в форму приложите ссылку на него.
Назовите rmd-файл своими ФИО.

Что нужно отправить: ссылку на репозиторий, который будет содержать rmd-файл с вашим решением.
